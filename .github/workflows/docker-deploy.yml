name: Docker Deploy (Server Build)

on:
  push:
    branches: ['master']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for lint/tests only, optional)
        uses: actions/checkout@v4

      # Optional: local CI sanity check
      # - name: Setup Node
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 20
      #   ...
      #   run: npm install && npm run lint && npm run build:production

      - name: SSH & Build on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }} # 216.48.179.224
          username: ${{ secrets.SSH_USER }} # meandev
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }} # 22
          script_stop: true
          script: |
            set -e

            echo ">>> Go to project directory"
            cd /home/daily_love/ai_dating_web

            echo ">>> Pull latest code from master"
            sudo git pull origin master

            echo ">>> Build Docker image"
            docker build -t daily_love_image:latest .

            echo ">>> Restart container via docker compose"
            cd /home/daily_love/docker
            docker compose down || true
            docker compose up -d

            echo ">>> Running containers:"
            docker ps
